from pathlib import Path
import shutil
import re

ROOT = Path(__file__).parent
IMAGES_DIR = ROOT / 'images'
TEMPLATE_DIR = ROOT / 'template'

shutil.rmtree(IMAGES_DIR, ignore_errors = True)
IMAGES_DIR.mkdir()

(IMAGES_DIR / 'DO_NOT_MODIFY').write_text('DO NOT MODIFY ANYTHING IN THIS DIRECTORY\nIT IS GENERATED BY make.py')

for base_image in (ROOT / 'BASE_IMAGES.txt').read_text().splitlines():
    repo, image, tag = re.match(r'(.*)\/(.*):(.*)', base_image).groups()

    our_image = 'htc-{}'.format(image)

    image_dir = IMAGES_DIR / our_image
    image_dir.mkdir()

    other_files = [p for p in TEMPLATE_DIR.iterdir() if p.name != 'Dockerfile']
    for p in other_files:
        shutil.copy2(p, image_dir / p.name)

    df = image_dir / 'Dockerfile'
    df_template = (TEMPLATE_DIR / 'Dockerfile').read_text()
    df_text = df_template.replace('<BASE_IMAGE>', base_image)
    df.write_text(df_text)
